<!DOCTYPE ahtml>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyber Dash: Security Runner</title>
    <style>
        /* FONT IMPORT */
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            /* Added vertical padding for space at the top and bottom */
            padding: 20px 0;
            background-color: #f7f7f7;
            font-family: 'Press Start 2P', cursive; /* Main font applied to body and main text */
            color: #333;
        }

        .game-container {
            border: 4px solid #333;
            box-shadow: 10px 10px 0px rgba(0, 0, 0, 0.2);
            background-color: #fff;
            width: 90%;
            max-width: 700px;
            position: relative;
            padding: 20px;
            box-sizing: border-box;
        }

        #gameCanvas {
            display: block;
            background: linear-gradient(to top, #e0e0e0 50%, #f0f0f0 50%);
            border-bottom: 2px solid #333;
        }

        #scoreDisplay {
            text-align: right;
            font-size: 14px;
            margin-bottom: 10px;
            color: #555;
        }

        /* --- MODAL STYLES (Applies to #messageBox, #startMenu, #studyMode, #moduleMode) --- */
        .full-overlay-modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none; 
            background: rgba(0, 0, 0, 0.7);
            align-items: center; 
            justify-content: center;
            z-index: 100;
            box-sizing: border-box;
        }
        
        #messageBox {
            /* Retains specific collision modal properties */
            padding-top: 0;
        }

        .modal-content {
            background-color: #fff;
            padding: 30px;
            padding-bottom: 40px; 
            border: 4px solid #333;
            box-shadow: 15px 15px 0px rgba(255, 0, 0, 0.8);
            max-width: 95%;
            text-align: center;
            color: #333;
            animation: fadeIn 0.3s ease-out;
        }
        
        .modal-title {
            font-size: 18px;
            color: #ff0000;
            margin-bottom: 15px;
        }

        .modal-text {
            font-size: 12px;
            margin: 10px 0;
            line-height: 1.5;
            color: #333;
        }
        
        /* CSS to prevent words like Wi-Fi from splitting */
        #questionText {
            word-break: normal; 
            overflow-wrap: break-word; 
            margin-bottom: 20px;
        }

        .modal-answer {
            margin-top: 20px;
        }

        /* Base style for Buttons */
        .button-style {
            font-family: 'Press Start 2P', cursive;
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin-top: 30px; 
            cursor: pointer;
            border: 3px solid #333;
            box-shadow: 4px 4px 0px #333;
            transition: all 0.1s;
            margin-bottom: 10px;
        }
        
        /* Specific button colors for modes */
        #quizModeButton { background-color: #007bff; }
        #studyModeButton { background-color: #ff9800; }
        #moduleModeButton { background-color: #f39c12; } /* New: Amber/Orange for Scenario Mode */
        
        #quizModeButton:hover { background-color: #0056b3; }
        #studyModeButton:hover { background-color: #e68900; }
        #moduleModeButton:hover { background-color: #e08e0b; }
        
        #exitStudyButton { background-color: #777; }
        #exitStudyButton:hover { background-color: #555; }
        #exitModuleButton { background-color: #999; } /* Darker gray for module exit */
        #exitModuleButton:hover { background-color: #666; }
        
        /* Game Over Buttons */
        /* Margin-top removed to rely on flex gap below */
        #restartButton { background-color: #ff0000; margin-top: 0; } 
        #restartButton:hover { background-color: #cc0000; }
        /* Margin-top removed to rely on flex gap below */
        #backToMenuButton { background-color: #007bff; margin-top: 0; } 
        #backToMenuButton:hover { background-color: #0056b3; }


        .button-style:hover {
            background-color: #45a049;
        }

        .button-style:active {
            box-shadow: 0 0 0 #333;
            transform: translate(4px, 4px);
        }
        
        .option-button {
            font-family: 'Press Start 2P', cursive; 
            background-color: #007bff; 
            color: white;
            padding: 8px 15px;
            text-align: center;
            font-size: 8px; 
            cursor: pointer;
            border: 3px solid #333;
            box-shadow: 3px 3px 0px #333;
            transition: all 0.1s;
            line-height: 1.2;
            width: 100%;
            white-space: normal; 
        }

        .option-button:hover:not(:disabled) {
            background-color: #0056b3;
        }

        .option-button:active:not(:disabled) {
            box-shadow: 0 0 0 #333;
            transform: translate(3px, 3px);
        }
        
        .correct-answer {
            background-color: #008000 !important; 
            color: white;
        }

        .incorrect-answer {
            background-color: #ff0000 !important; 
            color: white;
        }


        #gameOverScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 101;
            padding-bottom: 20px; 
        }
        
        #gameOverScreen h2 {
            font-size: 24px;
            color: #ff0000;
            /* Adjusted for more space on top */
            margin: 30px 0 15px 0; 
        }

        #gameOverScreen p {
            font-size: 14px;
            margin-bottom: 25px;
            padding-left: 20px; 
            padding-right: 20px; 
            text-align: center; 
        }
        
        /* Study Mode Specific Styles */
        #studyContent, #scenarioContent {
            background-color: #f0f8ff; /* Light blue background */
            padding: 20px;
            border: 3px dashed #007bff;
            margin-top: 15px;
            min-height: 150px;
        }
        #cisIndex, #scenarioIndex {
            font-size: 10px;
            margin-bottom: 5px;
            color: #007bff;
        }
        #cisTitle, #scenarioTitle {
            font-size: 14px;
            color: #000080; /* Dark blue */
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        #cisDescription, #scenarioText {
            font-size: 10px;
            line-height: 1.6;
            text-align: left;
        }
        #studyInstructions, #moduleInstructions {
             font-size: 8px;
             margin-top: 20px;
             color: #666;
        }
        
        .game-over-buttons {
            display: flex;
            flex-direction: column;
            /* Reduced gap between buttons */
            gap: 8px; 
            align-items: center;
        }

        /* Mobile adjustments */
        @media (max-width: 600px) {
            .game-container {
                width: 95%;
                max-width: 95%; 
                padding: 10px;
            }
            .modal-content {
                max-width: 95%; 
                padding-bottom: 30px; 
            }
            .modal-title {
                font-size: 14px;
            }
            .modal-text, .button-style {
                font-size: 10px;
            }
            #scoreDisplay {
                font-size: 10px;
            }
            .option-button {
                font-size: 8px; 
            }
            #gameOverScreen p {
                padding-left: 10px; 
                padding-right: 10px;
            }
            #cisTitle, #scenarioTitle {
                font-size: 12px;
            }
            #cisDescription, #scenarioText {
                font-size: 8px;
            }
        }
    </style>
</head>
<body>

    <h1 style="font-size: 20px; margin-bottom: 20px;">Cyber Dash: Security Runner</h1>

    <div class="game-container">
        <div id="scoreDisplay">Score: 0 | High: 0</div>
        <canvas id="gameCanvas" width="600" height="150"></canvas>
        
        <!-- START MENU SCREEN -->
        <div id="startMenu" class="full-overlay-modal" style="display: flex;">
            <div class="modal-content">
                <h3 class="modal-title">SELECT MODE</h3>
                <p class="modal-text" style="margin-bottom: 25px;">Choose your operation type.</p>
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <button id="quizModeButton" class="button-style" style="margin-top: 0;">
                        Quiz Mode (Start)
                    </button>
                    <button id="studyModeButton" class="button-style" style="margin-top: 0;">
                        Study Mode (CIS Controls)
                    </button>
                    <!-- NEW BUTTON FOR MODULE MODE -->
                    <button id="moduleModeButton" class="button-style" style="margin-top: 0;">
                        Module Mode (Scenario)
                    </button>
                </div>
                <p id="startInstructions" class="modal-text" style="font-size: 10px; margin-top: 30px; color: #666;">
                    <!-- Instructions updated via JS on load -->
                </p>
            </div>
        </div>

        <!-- STUDY MODE SCREEN -->
        <div id="studyMode" class="full-overlay-modal">
            <div class="modal-content">
                <h3 class="modal-title" style="color: #007bff;">CIS CONTROL STUDY MODULE</h3>
                
                <div id="studyContent">
                    <div id="cisIndex">CIS CONTROL X OF Y</div>
                    <div id="cisTitle"></div>
                    <div id="cisDescription"></div>
                </div>

                <p id="studyInstructions">
                    Use &larr; and &rarr; arrow keys to navigate. Press ENTER or the button below to exit.
                </p>
                
                <button id="exitStudyButton" class="button-style">Exit Study Mode</button>
            </div>
        </div>
        
        <!-- MODULE MODE SCREEN (NEW) -->
        <div id="moduleMode" class="full-overlay-modal">
            <div class="modal-content">
                <h3 class="modal-title" style="color: #f39c12;">CYBER SCENARIO MODULE</h3>
                
                <div id="scenarioContent">
                    <div id="scenarioIndex">SCENARIO X OF Y</div>
                    <div id="scenarioTitle" style="font-size: 14px; color: #333; margin: 10px 0;"></div>
                    <div id="scenarioText" style="font-size: 10px; line-height: 1.6; text-align: left;"></div>
                    <div id="scenarioQuestion" style="font-size: 10px; line-height: 1.6; text-align: left; font-weight: bold; margin-top: 15px; color: #ff0000;"></div>
                </div>

                <p id="moduleInstructions" style="font-size: 8px; margin-top: 20px; color: #666;">
                    Use &larr; and &rarr; arrow keys to navigate scenarios. Press the button to reveal the solution.
                </p>
                
                <!-- Reveal Button will be injected here by JS -->
                
                <button id="exitModuleButton" class="button-style" style="background-color: #999;">Exit Module Mode</button>
            </div>
        </div>


        <!-- Cybersecurity Modal / Pause Screen -->
        <div id="messageBox" class="full-overlay-modal">
            <div class="modal-content">
                <h3 id="modalTitle" class="modal-title">SECURITY CHECKPOINT REACHED!</h3>
                <div id="questionCounter" class="modal-text" style="font-size: 10px; font-weight: bold;"></div>
                <div id="topicText" class="modal-text"></div>
                <div id="cisControlText" class="modal-text" style="font-size: 10px; margin-bottom: 10px; color: #007bff; font-weight: bold;"></div>
                <div id="questionText" class="modal-text"></div>
                
                <div id="optionContainer" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
                    <!-- Options will be inserted here by JS -->
                </div>

                <div id="feedbackText" class="modal-answer modal-text" style="display: none;"></div>
                
                <button id="continueButton" class="button-style" style="display: none;">Continue Run</button>
            </div>
        </div>

        <!-- Game Over Screen -->
        <div id="gameOverScreen">
            <h2>GAME OVER!</h2>
            <p>You tripped over a vulnerability at <span id="finalScore">0</span> points.</p>
            
            <div class="game-over-buttons">
                <button id="restartButton" class="button-style">Retry Scan</button>
                <button id="backToMenuButton" class="button-style">Back to Main Menu</button>
            </div>
        </div>
    </div>

    <script>
        // --- GAME ASSET SETUP ---

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('scoreDisplay');
        
        // Modal & Screen elements
        const startMenu = document.getElementById('startMenu');
        const quizModeButton = document.getElementById('quizModeButton');
        const studyModeButton = document.getElementById('studyModeButton');
        const moduleModeButton = document.getElementById('moduleModeButton'); // New reference
        
        const studyMode = document.getElementById('studyMode');
        const cisIndex = document.getElementById('cisIndex');
        const cisTitle = document.getElementById('cisTitle');
        const cisDescription = document.getElementById('cisDescription');
        const exitStudyButton = document.getElementById('exitStudyButton');
        
        const moduleMode = document.getElementById('moduleMode'); // New modal reference
        const scenarioContent = document.getElementById('scenarioContent');
        const scenarioIndex = document.getElementById('scenarioIndex');
        const scenarioTitle = document.getElementById('scenarioTitle');
        const scenarioText = document.getElementById('scenarioText');
        const scenarioQuestion = document.getElementById('scenarioQuestion');
        const exitModuleButton = document.getElementById('exitModuleButton');
        
        const messageBox = document.getElementById('messageBox');
        const modalTitle = document.getElementById('modalTitle');
        const questionCounter = document.getElementById('questionCounter');
        const topicText = document.getElementById('topicText');
        const cisControlText = document.getElementById('cisControlText');
        const questionText = document.getElementById('questionText');
        const optionContainer = document.getElementById('optionContainer');
        const feedbackText = document.getElementById('feedbackText');
        const continueButton = document.getElementById('continueButton');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const restartButton = document.getElementById('restartButton');
        const backToMenuButton = document.getElementById('backToMenuButton');
        const finalScoreSpan = document.getElementById('finalScore');
        
        // Use a persistent object for game state
        let gameState = {
            mode: 'start', // 'start', 'quiz', 'study', or 'module'
            score: 0,
            highScore: localStorage.getItem('cyberDashHighScore') || 0,
            isRunning: false,
            animationFrameId: null,
            timeSinceLastObstacle: 0,
            obstacleGenerationInterval: 1200, 
            speed: 5,
            isPausedBySystem: false,
            obstaclesPassedCount: 0,
            checkpointsCleared: 0,
            currentQuestionSet: [],
            // Study Mode State
            currentCisIndex: 0,
            // Module Mode State
            currentModuleIndex: 0,
        };

        const GROUND_Y = canvas.height - 30;
        const DINO_WIDTH = 20;
        const DINO_HEIGHT = 40;
        const BLOCKS_PER_CHECKPOINT = 5; 
        const MAX_CHECKPOINTS = 5; 
        
        // Colors
        const DINO_COLOR = '#006400'; 
        const OBSTACLE_COLOR = '#8B0000'; 
        const GROUND_COLOR = '#333';
        
        // --- GAME ENTITIES (Unchanged Classes) ---

        class Dinosaur {
            constructor() {
                this.x = 50;
                this.y = GROUND_Y - DINO_HEIGHT;
                this.width = DINO_WIDTH;
                this.height = DINO_HEIGHT;
                this.velocityY = 0;
                this.isJumping = false;
                this.gravity = 0.6;
                this.jumpStrength = -13;
            }

            draw() {
                ctx.fillStyle = DINO_COLOR;
                ctx.fillRect(this.x, this.y, this.width, this.height);
                ctx.fillStyle = '#fff';
                ctx.fillRect(this.x + this.width / 2 - 2, this.y + 5, 4, 4);
            }

            update() {
                if (this.isJumping) {
                    this.y += this.velocityY;
                    this.velocityY += this.gravity;
                    if (this.y >= GROUND_Y - this.height) {
                        this.y = GROUND_Y - this.height;
                        this.isJumping = false;
                        this.velocityY = 0;
                    }
                }
            }

            jump() {
                if (!this.isJumping && gameState.isRunning && !gameState.isPausedBySystem) {
                    this.isJumping = true;
                    this.velocityY = this.jumpStrength;
                }
            }
        }

        class Obstacle {
            constructor(width, height) {
                this.x = canvas.width;
                this.y = GROUND_Y - height;
                this.width = width;
                this.height = height;
                this.passed = false;
            }

            draw() {
                ctx.fillStyle = OBSTACLE_COLOR;
                ctx.fillRect(this.x, this.y, this.width, this.height);
            }

            update() {
                this.x -= gameState.speed;
            }
        }

        // --- CYBERSECURITY DATA (Quiz Mode) ---

        const CYBER_TOPICS = [
            {
                topic: "Phishing Awareness",
                cisControl: "CIS Control 14: Security Awareness and Skills Training",
                question: "What is the primary sign of a malicious email?",
                options: [
                    "It uses a generic greeting like 'Dear Customer.'",
                    "It has urgent language demanding immediate action or clicking a suspicious link.",
                    "It contains no images or logos.",
                    "It is sent during non-business hours."
                ],
                correctIndex: 1,
                explanation: "Urgent language demanding immediate action and links to unknown sites are classic red flags for phishing. Generic greetings are also common, but the threat of immediate action is key."
            },
            {
                topic: "Strong Passwords & Passphrases",
                cisControl: "CIS Control 6: Access Control Management",
                question: "Which of the following creates the most secure login credential?",
                options: [
                    "P@sswOrd1!",
                    "A 4-word phrase: CorrectHorseBatteryStaple",
                    "Your name followed by your birth year.",
                    "A 10-character mix of letters and numbers."
                ],
                correctIndex: 1,
                explanation: "Passphrases (long, random sequences of words) are often significantly more secure and easier to remember than short, complex character strings."
            },
            {
                topic: "Multi-Factor Authentication (MFA)",
                cisControl: "CIS Control 6: Access Control Management",
                question: "If a hacker steals your password, what stops them from logging in if MFA is enabled?",
                options: [
                    "The MFA system will automatically lock their IP address.",
                    "The hacker cannot provide the second verification step (like a code from your phone or biometric scan).",
                    "MFA only works if the password is changed every 30 days.",
                    "MFA forces the hacker to use a different browser."
                ],
                correctIndex: 1,
                explanation: "MFA requires something the hacker *has* (like your phone/token) in addition to something they *know* (your password). Without the second factor, the login fails."
            },
            {
                topic: "Software Updates & Patching",
                cisControl: "CIS Control 7: Vulnerability Management",
                question: "What is the main reason security experts recommend immediate software updates?",
                options: [
                    "To introduce new graphical features.",
                    "To fix bugs that cause applications to crash.",
                    "To patch security vulnerabilities that attackers can exploit.",
                    "To optimize battery life on mobile devices."
                ],
                correctIndex: 2,
                explanation: "Security updates and patches often close critical vulnerabilities (holes) in the software that hackers look for. Delaying updates leaves your system exposed."
            },
            {
                topic: "Public Wi-Fi Security",
                cisControl: "CIS Control 13: Network Monitoring and Defense",
                question: "What is the safest practice when using public Wi-Fi at a cafe or airport?",
                options: [
                    "Avoid using any Wi-Fi that requires a password.",
                    "Assume all connections are secure and browse as normal.",
                    "Use a Virtual Private Network (VPN) for all sensitive activities.",
                    "Only visit websites that start with 'http://'."
                ],
                correctIndex: 2,
                explanation: "Public Wi-Fi is often unencrypted, meaning data can be easily intercepted. A VPN encrypts your connection, protecting your data."
            },
            {
                topic: "Identifying Malware",
                cisControl: "CIS Control 10: Malware Defenses",
                question: "What is the term for software designed to secretly monitor your actions and capture keystrokes?",
                options: [
                    "Adware",
                    "Ransomware",
                    "Spyware",
                    "Firmware"
                ],
                correctIndex: 2,
                explanation: "Spyware is malicious software designed to gather information about a person or organization without their knowledge and send it to another entity."
            },
             {
                topic: "Device Encryption",
                cisControl: "CIS Control 3: Data Protection",
                question: "Why is full-disk encryption (FDE) important for laptops and phones?",
                options: [
                    "It speeds up the device's boot time.",
                    "It prevents unauthorized access to data if the device is lost or stolen.",
                    "It automatically deletes sensitive files after 30 days.",
                    "It prevents phishing emails from reaching the device."
                ]
                ,
                correctIndex: 1,
                explanation: "If a device with FDE is stolen, the data on it is unreadable without the correct decryption key, protecting sensitive information."
            },
             {
                topic: "Data Backup",
                cisControl: "CIS Control 11: Data Recovery",
                question: "What is the most critical principle of effective data backup?",
                options: [
                    "Storing all backups in the cloud.",
                    "Storing backups on a separate, external hard drive.",
                    "The 3-2-1 Rule: 3 copies, 2 media types, 1 offsite.",
                    "Backing up data only once per year."
                ],
                correctIndex: 2,
                explanation: "The 3-2-1 rule is the industry standard: keep 3 copies of your data, on 2 different storage types, with 1 copy located offsite (e.g., in the cloud or a different location)."
            }
        ];
        
        // --- CIS CONTROL DATA (Study Mode) ---
        const CIS_CONTROLS_STUDY = [
            { 
                number: 6, 
                title: "CIS Control 6: Access Control Management", 
                description: "This control focuses on managing user identities and the authorization to access system resources. Implement strong account management processes, use unique passwords for all systems, and utilize Multi-Factor Authentication (MFA) to prevent unauthorized entry."
            },
            { 
                number: 7, 
                title: "CIS Control 7: Vulnerability Management", 
                description: "Proactively identify, prioritize, and remediate vulnerabilities in operating systems and applications. This includes immediate installation of security patches and updates to close known security holes before attackers can exploit them."
            },
            { 
                number: 10, 
                title: "CIS Control 10: Malware Defenses", 
                description: "Prevent or control the installation, spread, and execution of malicious software. Deploy and manage anti-malware software on all devices and ensure all incoming data (email, file downloads) is scanned for threats."
            },
            { 
                number: 13, 
                title: "CIS Control 13: Network Monitoring and Defense", 
                description: "Monitor and control network ports, protocols, and services. Use network firewalls and deploy intrusion detection/prevention systems. When operating on public networks (like Wi-Fi), always use a Virtual Private Network (VPN)."
            },
            { 
                number: 14, 
                title: "CIS Control 14: Security Awareness and Skills Training", 
                description: "Develop and maintain security awareness training for all personnel to minimize human error. Train employees to recognize social engineering tactics like phishing and baiting, as well as proper handling of sensitive data."
            }
        ];
        
        // --- MODULE SCENARIOS DATA (Module Mode) ---
        const MODULE_SCENARIOS = [
            {
                number: 1,
                title: "The Urgent IT Ticket Scam",
                description: "You receive an email claiming to be from IT Support. It says your account is locked due to 'suspicious activity' and you must click a link immediately to verify your password and unlock it. The email address looks slightly off: 'it-support@companyname.co' instead of 'it-support@companyname.com'.",
                question: "What is the safest immediate action?",
                answer: "Do not click the link. Report the email as phishing immediately, then call the official IT support desk using a verified number (not the one in the email) to confirm if your account is truly locked.",
                control: "CIS Control 14: Security Awareness and Skills Training"
            },
            {
                number: 2,
                title: "The USB Drive in the Parking Lot",
                description: "On your way into the office, you find a brand new, unlabeled USB drive lying next to your car in the parking lot. You are curious to know what files might be on it.",
                question: "What should you do with the USB drive?",
                answer: "Never plug unknown USB drives into your work or personal computer. These drives are often 'bait' loaded with malware. Turn it over to your security team or discard it according to company policy.",
                control: "CIS Control 10: Malware Defenses"
            },
            {
                number: 3,
                title: "The Public Wi-Fi Password Leak",
                description: "You're traveling and decide to work from an airport lounge. You successfully connect to the lounge's free Wi-Fi and open your banking website to check a balance. You notice the website address starts with 'http://' instead of 'https://'.",
                question: "What is the security risk, and how should you stop?",
                answer: "The risk is that 'http://' means your data is unencrypted, making it vulnerable to interception (sniffing) on the public network. Stop immediately and only proceed with sensitive activities (like banking) after connecting via a Virtual Private Network (VPN).",
                control: "CIS Control 13: Network Monitoring and Defense"
            }
        ];


        let dino;
        let obstacles = [];
        let lastTimestamp = 0;
        let currentTopic = null; 

        // --- UTILITY: SHUFFLE AND SELECT ---
        
        function shuffleAndSelectTopics() {
            const shuffled = [...CYBER_TOPICS]
                .map(value => ({ value, sort: Math.random() }))
                .sort((a, b) => a.sort - b.sort)
                .map(({ value }) => value);
            
            return shuffled.slice(0, MAX_CHECKPOINTS);
        }

        // --- GAME FLOW FUNCTIONS ---

        function showStartMenu() {
             // Reset canvas message
            drawInitialMessage(); 
            
            // Hide all overlays
            messageBox.style.display = 'none';
            gameOverScreen.style.display = 'none';
            studyMode.style.display = 'none';
            moduleMode.style.display = 'none'; // New: Hide module mode

            // Show start menu
            startMenu.style.display = 'flex';
            
            // Reset game state for a clean start
            gameState.isRunning = false;
            gameState.isPausedBySystem = false;
            gameState.mode = 'start';
            
            // Update the static score display
            gameState.highScore = localStorage.getItem('cyberDashHighScore') || 0;
            scoreDisplay.innerHTML = `Score: 0 | High: ${gameState.highScore}`;
            
            // Update instructions for the new mode
            document.getElementById('startInstructions').innerHTML = `
                Quiz Mode: Jump to avoid vulnerabilities and answer questions at checkpoints.
                <br><br>
                Study Mode: Review foundational CIS Controls.
                <br><br>
                Module Mode: Explore real-world cyber security scenarios and best practices.
            `;
        }
        
        function startQuizMode() {
            gameState.mode = 'quiz';
            startMenu.style.display = 'none';
            initGame();
        }

        function startStudyMode() {
            gameState.mode = 'study';
            gameState.currentCisIndex = 0; // Start at the first control
            startMenu.style.display = 'none';
            studyMode.style.display = 'flex';
            displayCisControl(gameState.currentCisIndex);
        }
        
        function exitStudyMode() {
            studyMode.style.display = 'none';
            showStartMenu();
        }
        
        function startModuleMode() {
            gameState.mode = 'module';
            gameState.currentModuleIndex = 0;
            startMenu.style.display = 'none';
            moduleMode.style.display = 'flex'; // Show the new modal
            displayScenario(gameState.currentModuleIndex);
        }
        
        function exitModuleMode() {
            moduleMode.style.display = 'none';
            showStartMenu();
        }
        
        function displayCisControl(index) {
            const control = CIS_CONTROLS_STUDY[index];
            if (!control) {
                exitStudyMode(); // Should not happen if boundaries are checked
                return;
            }
            
            cisIndex.textContent = `CIS CONTROL ${index + 1} OF ${CIS_CONTROLS_STUDY.length}`;
            cisTitle.textContent = control.title;
            cisDescription.textContent = control.description;
        }
        
        function displayScenario(index) {
            const scenario = MODULE_SCENARIOS[index];
            if (!scenario) {
                exitModuleMode();
                return;
            }
            
            // Update Text Content
            scenarioIndex.textContent = `SCENARIO ${index + 1} OF ${MODULE_SCENARIOS.length}`;
            scenarioTitle.textContent = scenario.title;
            scenarioText.innerHTML = `<strong>Situation:</strong> ${scenario.description} <br><br> <strong>Control Focus:</strong> ${scenario.control}`;
            scenarioQuestion.textContent = `Question: ${scenario.question}`;
            
            // Answer Reveal Logic
            let answerReveal = document.getElementById('answerReveal');
            let revealButton = document.getElementById('revealButton');

            if (!answerReveal) {
                answerReveal = document.createElement('div');
                answerReveal.id = 'answerReveal';
                answerReveal.style.marginTop = '20px';
                answerReveal.style.borderTop = '2px dashed #ccc';
                answerReveal.style.paddingTop = '10px';
                answerReveal.style.textAlign = 'left';
                answerReveal.style.fontSize = '10px';
                answerReveal.style.color = '#006400';
                scenarioContent.appendChild(answerReveal);
            }
            
            if (!revealButton) {
                revealButton = document.createElement('button');
                revealButton.id = 'revealButton';
                revealButton.classList.add('button-style');
                revealButton.style.backgroundColor = '#2c3e50'; // Dark color
                revealButton.style.marginTop = '20px';
                revealButton.style.fontSize = '10px';
                revealButton.style.marginBottom = '10px';
                revealButton.onclick = () => {
                    const isHidden = answerReveal.style.display === 'none';
                    answerReveal.style.display = isHidden ? 'block' : 'none';
                    revealButton.textContent = isHidden ? 'Hide Solution' : 'Reveal Solution';
                };
                moduleMode.querySelector('.modal-content').insertBefore(revealButton, exitModuleButton);
            }

            // Reset state and content for the current scenario
            revealButton.textContent = 'Reveal Solution';
            answerReveal.style.display = 'none'; 
            answerReveal.innerHTML = `<strong>Solution:</strong> ${scenario.answer}`;
        }


        // --- QUIZ GAME LOGIC ---

        function initGame() {
            // Reset game state for the runner
            gameState.score = 0;
            gameState.isRunning = true;
            gameState.isPausedBySystem = false;
            gameState.speed = 5;
            gameState.obstaclesPassedCount = 0; 
            gameState.checkpointsCleared = 0; 
            obstacles = [];
            
            gameState.currentQuestionSet = shuffleAndSelectTopics(); 
            
            setGameOverScreen(false); // Reset to loss message
            messageBox.style.display = 'none';
            gameOverScreen.style.display = 'none';

            // Initialize entities
            dino = new Dinosaur();

            // Start the main loop
            if (gameState.animationFrameId) {
                cancelAnimationFrame(gameState.animationFrameId);
            }
            lastTimestamp = performance.now();
            gameLoop(lastTimestamp);
        }
        
        function drawGround() {
            ctx.strokeStyle = GROUND_COLOR;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(0, GROUND_Y);
            ctx.lineTo(canvas.width, GROUND_Y);
            ctx.stroke();
        }

        function generateObstacle() {
            const minHeight = 20;
            const maxHeight = 40;
            const minWidth = 10;
            const maxWidth = 30;

            const height = Math.random() * (maxHeight - minHeight) + minHeight;
            const width = Math.random() * (maxWidth - minWidth) + minWidth;

            obstacles.push(new Obstacle(width, height));
        }

        function checkCollision(dino, obstacle) {
            return (
                dino.x < obstacle.x + obstacle.width &&
                dino.x + dino.width > obstacle.x &&
                dino.y < obstacle.y + obstacle.height &&
                dino.y + dino.height > obstacle.y
            );
        }
        
        function updateSpeedAndDifficulty() {
            if (gameState.score > 0 && Math.floor(gameState.score) % 100 === 0) {
                if (Math.floor(gameState.score) !== gameState.lastScoreBeforeSpeedIncrease) {
                    gameState.speed = Math.min(gameState.speed + 0.5, 10); 
                    gameState.lastScoreBeforeSpeedIncrease = Math.floor(gameState.score); 
                }
            }
        }

        function gameLoop(timestamp) {
            const deltaTime = timestamp - lastTimestamp;
            lastTimestamp = timestamp;

            scoreDisplay.innerHTML = `Score: ${Math.floor(gameState.score)} | High: ${gameState.highScore}`;
            
            if (gameState.isRunning && !gameState.isPausedBySystem) {
                // 1. Clear Canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // 2. Draw Ground
                drawGround();

                // 3. Update Dino
                dino.update();
                dino.draw();

                // 4. Update Score
                gameState.score += 0.05; 
                updateSpeedAndDifficulty();
                
                // 5. Obstacle Logic
                gameState.timeSinceLastObstacle += deltaTime;
                if (gameState.timeSinceLastObstacle > gameState.obstacleGenerationInterval) {
                    generateObstacle();
                    gameState.timeSinceLastObstacle = 0;
                    gameState.obstacleGenerationInterval = Math.max(800, gameState.obstacleGenerationInterval * 0.98);
                }

                obstacles.forEach((obstacle) => {
                    obstacle.update();
                    obstacle.draw();

                    if (checkCollision(dino, obstacle)) {
                        gameOver();
                        return; 
                    }

                    if (obstacle.x + obstacle.width < dino.x && !obstacle.passed) {
                        obstacle.passed = true;
                        gameState.obstaclesPassedCount++;
                    }
                });

                if (gameState.obstaclesPassedCount >= BLOCKS_PER_CHECKPOINT) {
                    gameState.obstaclesPassedCount = 0;
                    pauseGameForSecurityCheck();
                }

                obstacles = obstacles.filter(obstacle => obstacle.x + obstacle.width > 0);
            }
            
            gameState.animationFrameId = requestAnimationFrame(gameLoop);
        }

        function setGameOverScreen(isWin = false) {
            finalScoreSpan.textContent = Math.floor(gameState.score);
            if (isWin) {
                gameOverScreen.querySelector('h2').textContent = 'MISSION COMPLETE!';
                gameOverScreen.querySelector('h2').style.color = '#006400'; 
                gameOverScreen.querySelector('p').innerHTML = `You successfully cleared all security checkpoints with a final score of <span id="finalScore">${Math.floor(gameState.score)}</span>!`;
                restartButton.textContent = 'Start New Scan';
                backToMenuButton.style.backgroundColor = '#007bff'; // Change color for success screen
            } else {
                gameOverScreen.querySelector('h2').textContent = 'GAME OVER!';
                gameOverScreen.querySelector('h2').style.color = '#ff0000'; 
                gameOverScreen.querySelector('p').innerHTML = `You tripped over a vulnerability at <span id="finalScore">${Math.floor(gameState.score)}</span> points.`;
                restartButton.textContent = 'Retry Scan';
                backToMenuButton.style.backgroundColor = '#007bff';
            }
        }

        function gameOver() {
            gameState.isRunning = false;
            setGameOverScreen(false);
            gameOverScreen.style.display = 'flex';

            if (Math.floor(gameState.score) > gameState.highScore) {
                gameState.highScore = Math.floor(gameState.score);
                localStorage.setItem('cyberDashHighScore', gameState.highScore);
                scoreDisplay.innerHTML = `Score: ${Math.floor(gameState.score)} | High: ${gameState.highScore} (NEW!)`;
            }
            
            cancelAnimationFrame(gameState.animationFrameId);
        }

        function gameWin() {
            gameState.isRunning = false;
            setGameOverScreen(true); 
            gameOverScreen.style.display = 'flex';

            if (Math.floor(gameState.score) > gameState.highScore) {
                gameState.highScore = Math.floor(gameState.score);
                localStorage.setItem('cyberDashHighScore', gameState.highScore);
                scoreDisplay.innerHTML = `Score: ${Math.floor(gameState.score)} | High: ${gameState.highScore} (NEW!)`;
            }

            cancelAnimationFrame(gameState.animationFrameId);
        }
        
        function pauseGameForSecurityCheck() {
            
            if (gameState.checkpointsCleared >= MAX_CHECKPOINTS) {
                gameWin();
                return;
            }

            gameState.isRunning = false;
            gameState.isPausedBySystem = true;
            gameState.checkpointsCleared++; 

            currentTopic = gameState.currentQuestionSet[gameState.checkpointsCleared - 1]; 

            modalTitle.textContent = 'SECURITY CHECKPOINT REACHED!';
            questionCounter.textContent = `Question ${gameState.checkpointsCleared} of ${MAX_CHECKPOINTS}`;
            topicText.textContent = `Topic: ${currentTopic.topic}`;
            cisControlText.textContent = `(${currentTopic.cisControl})`;
            questionText.textContent = `Q: ${currentTopic.question}`;
            
            feedbackText.style.display = 'none';
            continueButton.style.display = 'none';
            optionContainer.innerHTML = ''; 

            currentTopic.options.forEach((optionText, index) => {
                const button = document.createElement('button');
                button.textContent = optionText;
                button.classList.add('option-button');
                button.dataset.index = index;
                
                button.addEventListener('click', handleAnswer);
                optionContainer.appendChild(button);
            });
            
            messageBox.style.display = 'flex';
        }

        function handleAnswer(event) {
            if (!currentTopic) return;

            const selectedButton = event.currentTarget;
            const selectedIndex = parseInt(selectedButton.dataset.index);
            const isCorrect = selectedIndex === currentTopic.correctIndex;
            const allButtons = optionContainer.querySelectorAll('.option-button');

            allButtons.forEach(btn => {
                btn.disabled = true;
                btn.removeEventListener('click', handleAnswer);
            });

            if (isCorrect) {
                selectedButton.classList.add('correct-answer');
                feedbackText.textContent = `CORRECT! (+15 pts)\n\nExplanation: ${currentTopic.explanation}`;
                gameState.score += 15;
            } else {
                selectedButton.classList.add('incorrect-answer');
                allButtons[currentTopic.correctIndex].classList.add('correct-answer');
                feedbackText.textContent = `INCORRECT. The correct answer is highlighted.\n\nExplanation: ${currentTopic.explanation}`;
            }

            feedbackText.style.display = 'block';
            continueButton.style.display = 'inline-block';
            
            if (gameState.checkpointsCleared >= MAX_CHECKPOINTS) {
                continueButton.textContent = 'Mission Accomplished!';
            } else {
                 continueButton.textContent = 'Continue Run';
            }

            scoreDisplay.innerHTML = `Score: ${Math.floor(gameState.score)} | High: ${gameState.highScore}`;
        }
        
        function resumeGame() {
            messageBox.style.display = 'none';
            
            if (gameState.checkpointsCleared >= MAX_CHECKPOINTS) {
                gameWin();
                return;
            }

            obstacles = []; 
            gameState.timeSinceLastObstacle = 0; 
            
            gameState.isRunning = true;
            gameState.isPausedBySystem = false;
            lastTimestamp = performance.now(); 
        }

        // --- EVENT LISTENERS ---

        document.addEventListener('keydown', (e) => {
            // Check for Quiz Mode controls
            if (gameState.mode === 'quiz') {
                if (e.code === 'Space' || e.code === 'ArrowUp') {
                    e.preventDefault(); 
                    if (gameState.isRunning) {
                        dino.jump();
                    }
                }
            } 
            
            // Check for Study Mode controls
            else if (gameState.mode === 'study') {
                const totalControls = CIS_CONTROLS_STUDY.length;
                if (e.code === 'ArrowRight') {
                    gameState.currentCisIndex = (gameState.currentCisIndex + 1) % totalControls;
                    displayCisControl(gameState.currentCisIndex);
                } else if (e.code === 'ArrowLeft') {
                    gameState.currentCisIndex = (gameState.currentCisIndex - 1 + totalControls) % totalControls;
                    displayCisControl(gameState.currentCisIndex);
                } else if (e.code === 'Enter' || e.code === 'Escape') {
                    exitStudyMode();
                }
            }
            
            // Check for Module Mode controls (NEW)
            else if (gameState.mode === 'module') {
                const totalModules = MODULE_SCENARIOS.length;
                if (e.code === 'ArrowRight') {
                    gameState.currentModuleIndex = (gameState.currentModuleIndex + 1) % totalModules;
                    displayScenario(gameState.currentModuleIndex);
                } else if (e.code === 'ArrowLeft') {
                    gameState.currentModuleIndex = (gameState.currentModuleIndex - 1 + totalModules) % totalModules;
                    displayScenario(gameState.currentModuleIndex);
                } else if (e.code === 'Enter' || e.code === 'Escape') {
                    exitModuleMode();
                }
            }
            
            // Check for universal controls (Game Over / Start Menu)
            else if (gameState.mode === 'start') {
                 if (e.code === 'Space' || e.code === 'ArrowUp') {
                     e.preventDefault();
                     startQuizMode(); // Default to quiz mode from start menu on jump/space
                 }
            }
        });

        canvas.addEventListener('click', (e) => {
             if (gameState.mode === 'quiz' && gameState.isRunning) {
                dino.jump();
            } else if (gameState.mode === 'start') {
                startQuizMode(); // Default to quiz mode from start menu on click
            }
        });

        // Button listeners
        quizModeButton.addEventListener('click', startQuizMode);
        studyModeButton.addEventListener('click', startStudyMode);
        moduleModeButton.addEventListener('click', startModuleMode); // New Listener
        
        exitStudyButton.addEventListener('click', exitStudyMode);
        exitModuleButton.addEventListener('click', exitModuleMode); // New Listener
        
        continueButton.addEventListener('click', resumeGame);
        restartButton.addEventListener('click', initGame); // Retry Scan button starts the game again
        backToMenuButton.addEventListener('click', showStartMenu); // New: Back to menu button goes to start menu

        // --- INITIAL DISPLAY ---
        
        function drawInitialMessage() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawGround();
            ctx.fillStyle = DINO_COLOR;
            ctx.fillRect(50, GROUND_Y - DINO_HEIGHT, DINO_WIDTH, DINO_HEIGHT); 
            
            ctx.fillStyle = GROUND_COLOR;
            ctx.font = '12px "Press Start 2P"'; 
            ctx.textAlign = 'center';
            ctx.fillText("CYBER DASH RUNNER", canvas.width / 2, canvas.height / 2 - 10);
            ctx.font = '8px "Press Start 2P"';
            ctx.fillText("Select a mode to begin", canvas.width / 2, canvas.height / 2 + 10);
        }

        window.onload = () => {
            const container = document.querySelector('.game-container');
            canvas.width = container.clientWidth - 40; 
            
            gameState.highScore = localStorage.getItem('cyberDashHighScore') || 0;
            
            // Start the game loop only to draw the initial screen and handle resizes
            gameLoop(performance.now());
            
            showStartMenu();
        };

        window.addEventListener('resize', () => {
             const container = document.querySelector('.game-container');
             canvas.width = container.clientWidth - 40;
             if (gameState.mode === 'start') {
                drawInitialMessage();
             }
        });

    </script>
</body>
</html>