<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyber Dash: Security Runner</title>
    <style>
        /* FONT IMPORT */
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            /* Added vertical padding for space at the top and bottom */
            padding: 20px 0;
            background-color: #f7f7f7;
            font-family: 'Press Start 2P', cursive; /* Main font applied to body and main text */
            color: #333;
        }

        .game-container {
            border: 4px solid #333;
            box-shadow: 10px 10px 0px rgba(0, 0, 0, 0.2);
            background-color: #fff;
            width: 90%;
            max-width: 700px;
            position: relative;
            padding: 20px;
            box-sizing: border-box;
        }

        #gameCanvas {
            display: block;
            background: linear-gradient(to top, #e0e0e0 50%, #f0f0f0 50%);
            border-bottom: 2px solid #333;
        }

        #scoreDisplay {
            text-align: right;
            font-size: 14px;
            margin-bottom: 10px;
            color: #555;
        }

        /* --- MODAL STYLES (Applies to #messageBox, #startMenu, #studyMode) --- */
        .full-overlay-modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none; 
            background: rgba(0, 0, 0, 0.7);
            align-items: center; 
            justify-content: center;
            z-index: 100;
            box-sizing: border-box;
        }
        
        #messageBox {
            /* Retains specific collision modal properties */
            padding-top: 0;
        }

        .modal-content {
            background-color: #fff;
            padding: 30px;
            padding-bottom: 40px; 
            border: 4px solid #333;
            box-shadow: 15px 15px 0px rgba(255, 0, 0, 0.8);
            max-width: 95%;
            text-align: center;
            color: #333;
            animation: fadeIn 0.3s ease-out;
        }
        
        .modal-title {
            font-size: 18px;
            color: #ff0000;
            margin-bottom: 15px;
        }

        .modal-text {
            font-size: 12px;
            margin: 10px 0;
            line-height: 1.5;
            color: #333;
        }
        
        /* CSS to prevent words like Wi-Fi from splitting */
        #questionText {
            word-break: normal; 
            overflow-wrap: break-word; 
            margin-bottom: 20px;
        }

        .modal-answer {
            margin-top: 20px;
        }

        /* Base style for Buttons */
        .button-style {
            font-family: 'Press Start 2P', cursive;
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin-top: 30px; 
            cursor: pointer;
            border: 3px solid #333;
            box-shadow: 4px 4px 0px #333;
            transition: all 0.1s;
            margin-bottom: 10px;
            /* Ensure all buttons are focusable for accessibility */
            outline: none; 
        }
        
        /* Focus state for keyboard navigation */
        .button-style:focus, .option-button:focus {
            /* Updated for Black/White high-contrast focus glow */
            box-shadow: 
                0 0 0 5px #fff,  /* White inner glow for contrast */
                0 0 0 8px #000,  /* Black outer ring */
                4px 4px 0px #333; /* Original shadow preserved */
            transform: translate(0, 0); 
        }
        
        /* Specific button colors for modes */
        #quizModeButton { background-color: #007bff; }
        #studyModeButton { background-color: #ff9800; }
        
        #quizModeButton:hover { background-color: #0056b3; }
        #studyModeButton:hover { background-color: #e68900; }
        
        #exitStudyButton { background-color: #777; }
        #exitStudyButton:hover { background-color: #555; }
        
        /* Game Over Buttons */
        /* Margin-top removed to rely on flex gap below */
        #restartButton { background-color: #ff0000; margin-top: 0; } 
        #restartButton:hover { background-color: #cc0000; }
        /* Margin-top removed to rely on flex gap below */
        #backToMenuButton { background-color: #007bff; margin-top: 0; } 
        #backToMenuButton:hover { background-color: #0056b3; }

        .button-style:hover {
            background-color: #45a049;
        }

        .button-style:active {
            box-shadow: 0 0 0 #333;
            transform: translate(4px, 4px);
        }
        
        .option-button {
            font-family: 'Press Start 2P', cursive; 
            background-color: #007bff; 
            color: white;
            padding: 8px 15px;
            text-align: center;
            font-size: 8px; 
            cursor: pointer;
            border: 3px solid #333;
            box-shadow: 3px 3px 0px #333;
            transition: all 0.1s;
            line-height: 1.2;
            width: 100%;
            white-space: normal; 
            outline: none; /* remove default focus ring */
        }

        .option-button:hover:not(:disabled) {
            background-color: #0056b3;
        }

        .option-button:active:not(:disabled) {
            box-shadow: 0 0 0 #333;
            transform: translate(3px, 3px);
        }
        
        .correct-answer {
            background-color: #008000 !important; 
            color: white;
        }

        .incorrect-answer {
            background-color: #ff0000 !important; 
            color: white;
        }

        #gameOverScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 101;
            padding-bottom: 20px; 
        }
        
        #gameOverScreen h2 {
            font-size: 24px;
            color: #ff0000;
            /* Adjusted for more space on top */
            margin: 30px 0 15px 0; 
        }

        #gameOverScreen p {
            font-size: 14px;
            margin-bottom: 25px;
            padding-left: 20px; 
            padding-right: 20px; 
            text-align: center; 
        }
        
        /* Study Mode Specific Styles */
        #studyContent {
            background-color: #f0f8ff; /* Light blue background */
            padding: 20px;
            border: 3px dashed #007bff;
            margin-top: 15px;
            min-height: 150px;
        }
        #cisIndex {
            font-size: 10px;
            margin-bottom: 5px;
            color: #007bff;
        }
        #cisTitle {
            font-size: 14px;
            color: #000080; /* Dark blue */
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        #cisDescription {
            font-size: 10px;
            line-height: 1.6;
            text-align: left;
        }
        #studyInstructions {
             font-size: 8px;
             margin-top: 20px;
             color: #666;
        }
        
        .game-over-buttons {
            display: flex;
            flex-direction: column;
            /* Reduced gap between buttons */
            gap: 8px; 
            align-items: center;
        }

        /* Mobile adjustments */
        @media (max-width: 600px) {
            .game-container {
                width: 95%;
                max-width: 95%; 
                padding: 10px;
            }
            .modal-content {
                max-width: 95%; 
                padding-bottom: 30px; 
            }
            .modal-title {
                font-size: 14px;
            }
            .modal-text, .button-style {
                font-size: 10px;
            }
            #scoreDisplay {
                font-size: 10px;
            }
            .option-button {
                font-size: 8px; 
            }
            #gameOverScreen p {
                padding-left: 10px; 
                padding-right: 10px;
            }
            #cisTitle {
                font-size: 12px;
            }
            #cisDescription {
                font-size: 8px;
            }
        }
    </style>
</head>
<body>

    <h1 style="font-size: 20px; margin-bottom: 20px;">Cyber Dash: Security Runner</h1>

    <div class="game-container">
        <div id="scoreDisplay">Score: 0 | High: 0</div>
        <canvas id="gameCanvas" width="600" height="150"></canvas>
        
        <!-- START MENU SCREEN -->
        <div id="startMenu" class="full-overlay-modal" style="display: flex;">
            <div class="modal-content">
                <h3 class="modal-title">SELECT MODE</h3>
                <p class="modal-text" style="margin-bottom: 25px;">Choose your operation type.</p>
                <div id="startMenuButtons" style="display: flex; flex-direction: column; gap: 15px;">
                    <!-- Added tabindex="0" to all interactive buttons for keyboard focus -->
                    <button id="quizModeButton" class="button-style" style="margin-top: 0;" tabindex="0">
                        Quiz Mode (Start)
                    </button>
                    <button id="studyModeButton" class="button-style" style="margin-top: 0;" tabindex="0">
                        Study Mode (CIS Controls)
                    </button>
                </div>
                <p id="startInstructions" class="modal-text" style="font-size: 10px; margin-top: 30px; color: #666;">
                    Quiz Mode: Jump to avoid vulnerabilities and answer questions at checkpoints.
                    <br><br>
                    Study Mode: Review foundational CIS Controls.
                    <br><br>
                    Use &uarr; / &darr; to navigate menus and ENTER to select.
                </p>
            </div>
        </div>

        <!-- STUDY MODE SCREEN -->
        <div id="studyMode" class="full-overlay-modal">
            <div class="modal-content">
                <h3 class="modal-title" style="color: #007bff;">CIS CONTROL STUDY MODULE</h3>
                
                <div id="studyContent">
                    <div id="cisIndex">CIS CONTROL X OF Y</div>
                    <div id="cisTitle"></div>
                    <div id="cisDescription"></div>
                </div>

                <p id="studyInstructions">
                    Use &larr; and &rarr; arrow keys to navigate. Press ENTER or the button below to exit.
                </p>
                
                <button id="exitStudyButton" class="button-style" tabindex="0">Exit Study Mode</button>
            </div>
        </div>

        <!-- Cybersecurity Modal / Pause Screen -->
        <div id="messageBox" class="full-overlay-modal">
            <div class="modal-content">
                <h3 id="modalTitle" class="modal-title">SECURITY CHECKPOINT REACHED!</h3>
                <div id="questionCounter" class="modal-text" style="font-size: 10px; font-weight: bold;"></div>
                <div id="topicText" class="modal-text"></div>
                <div id="cisControlText" class="modal-text" style="font-size: 10px; margin-bottom: 10px; color: #007bff; font-weight: bold;"></div>
                <div id="questionText" class="modal-text"></div>
                
                <div id="optionContainer" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
                    <!-- Options will be inserted here by JS -->
                </div>

                <div id="feedbackText" class="modal-answer modal-text" style="display: none;"></div>
                
                <button id="continueButton" class="button-style" style="display: none;" tabindex="0">Continue Run</button>
            </div>
        </div>

        <!-- Game Over Screen -->
        <div id="gameOverScreen">
            <h2>GAME OVER!</h2>
            <p>You tripped over a vulnerability at <span id="finalScore">0</span> points.</p>
            
            <div class="game-over-buttons">
                <button id="restartButton" class="button-style" tabindex="0">Retry Scan</button>
                <button id="backToMenuButton" class="button-style" tabindex="0">Back to Main Menu</button>
            </div>
        </div>
    </div>

    <script>
        // --- GAME ASSET SETUP ---

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('scoreDisplay');
        
        // Modal & Screen elements
        const startMenu = document.getElementById('startMenu');
        const startMenuButtons = document.getElementById('startMenuButtons');
        const quizModeButton = document.getElementById('quizModeButton');
        const studyModeButton = document.getElementById('studyModeButton');
        
        const studyMode = document.getElementById('studyMode');
        const cisIndex = document.getElementById('cisIndex');
        const cisTitle = document.getElementById('cisTitle');
        const cisDescription = document.getElementById('cisDescription');
        const exitStudyButton = document.getElementById('exitStudyButton');
        
        const messageBox = document.getElementById('messageBox');
        const modalTitle = document.getElementById('modalTitle');
        const questionCounter = document.getElementById('questionCounter');
        const topicText = document.getElementById('topicText');
        const cisControlText = document.getElementById('cisControlText');
        const questionText = document.getElementById('questionText');
        const optionContainer = document.getElementById('optionContainer');
        const feedbackText = document.getElementById('feedbackText');
        const continueButton = document.getElementById('continueButton');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const gameOverButtons = gameOverScreen.querySelector('.game-over-buttons');
        const restartButton = document.getElementById('restartButton');
        const backToMenuButton = document.getElementById('backToMenuButton');
        const finalScoreSpan = document.getElementById('finalScore');
        
        // Use a persistent object for game state
        let gameState = {
            mode: 'start', // 'start', 'quiz', or 'study'
            score: 0,
            highScore: localStorage.getItem('cyberDashHighScore') || 0,
            isRunning: false,
            animationFrameId: null,
            timeSinceLastObstacle: 0,
            obstacleGenerationInterval: 1200, 
            speed: 5,
            isPausedBySystem: false,
            obstaclesPassedCount: 0,
            checkpointsCleared: 0,
            currentQuestionSet: [],
            // Study Mode State
            currentCisIndex: 0
        };

        const GROUND_Y = canvas.height - 30;
        const DINO_WIDTH = 20;
        const DINO_HEIGHT = 40;
        const BLOCKS_PER_CHECKPOINT = 5; 
        const MAX_CHECKPOINTS = 5; 
        
        // Colors
        const DINO_COLOR = '#006400'; 
        const OBSTACLE_COLOR = '#8B0000'; 
        const GROUND_COLOR = '#333';
        
        // --- GAME ENTITIES ---

        class Dinosaur {
            constructor() {
                this.x = 50;
                this.y = GROUND_Y - DINO_HEIGHT;
                this.width = DINO_WIDTH;
                this.height = DINO_HEIGHT;
                this.velocityY = 0;
                this.isJumping = false;
                this.gravity = 0.6;
                this.jumpStrength = -13;
            }

            draw() {
                ctx.fillStyle = DINO_COLOR;
                ctx.fillRect(this.x, this.y, this.width, this.height);
                ctx.fillStyle = '#fff';
                ctx.fillRect(this.x + this.width / 2 - 2, this.y + 5, 4, 4);
            }

            update() {
                if (this.isJumping) {
                    this.y += this.velocityY;
                    this.velocityY += this.gravity;
                    if (this.y >= GROUND_Y - this.height) {
                        this.y = GROUND_Y - this.height;
                        this.isJumping = false;
                        this.velocityY = 0;
                    }
                }
            }

            jump() {
                if (!this.isJumping && gameState.isRunning && !gameState.isPausedBySystem) {
                    this.isJumping = true;
                    this.velocityY = this.jumpStrength;
                }
            }
        }

        class Obstacle {
             constructor(width, height) {
                this.x = canvas.width;
                this.y = GROUND_Y - height;
                this.width = width;
                this.height = height;
                this.passed = false;
            }

            draw() {
                ctx.fillStyle = OBSTACLE_COLOR;
                ctx.fillRect(this.x, this.y, this.width, this.height);
            }

            update() {
                this.x -= gameState.speed;
            }
        }

        // --- CYBERSECURITY DATA (Quiz Mode) ---
        const CYBER_TOPICS = [
            {
                topic: "Phishing Awareness",
                cisControl: "CIS Control 14: Security Awareness and Skills Training",
                question: "What is the primary sign of a malicious email?",
                options: [
                    "It uses a generic greeting like 'Dear Customer.'",
                    "It has urgent language demanding immediate action or clicking a suspicious link.",
                    "It contains no images or logos.",
                    "It is sent during non-business hours."
                ],
                correctIndex: 1,
                explanation: "Urgent language demanding immediate action and links to unknown sites are classic red flags for phishing. Generic greetings are also common, but the threat of immediate action is key."
            },
            {
                topic: "Strong Passwords & Passphrases",
                cisControl: "CIS Control 6: Access Control Management",
                question: "Which of the following creates the most secure login credential?",
                options: [
                    "P@sswOrd1!",
                    "A 4-word phrase: CorrectHorseBatteryStaple",
                    "Your name followed by your birth year.",
                    "A 10-character mix of letters and numbers."
                ],
                correctIndex: 1,
                explanation: "Passphrases (long, random sequences of words) are often significantly more secure and easier to remember than short, complex character strings."
            },
            {
                topic: "Multi-Factor Authentication (MFA)",
                cisControl: "CIS Control 6: Access Control Management",
                question: "If a hacker steals your password, what stops them from logging in if MFA is enabled?",
                options: [
                    "The MFA system will automatically lock their IP address.",
                    "The hacker cannot provide the second verification step (like a code from your phone or biometric scan).",
                    "MFA only works if the password is changed every 30 days.",
                    "MFA forces the hacker to use a different browser."
                ],
                correctIndex: 1,
                explanation: "MFA requires something the hacker *has* (like your phone/token) in addition to something they *know* (your password). Without the second factor, the login fails."
            },
            {
                topic: "Software Updates & Patching",
                cisControl: "CIS Control 7: Continuous Vulnerability Management",
                question: "What is the main reason security experts recommend immediate software updates?",
                options: [
                    "To introduce new graphical features.",
                    "To fix bugs that cause applications to crash.",
                    "To patch security vulnerabilities that attackers can exploit.",
                    "To optimize battery life on mobile devices."
                ],
                correctIndex: 2,
                explanation: "Security updates and patches often close critical vulnerabilities (holes) in the software that hackers look for. Delaying updates leaves your system exposed."
            },
            {
                topic: "Public Wi-Fi Security",
                cisControl: "CIS Control 13: Network Monitoring and Defense",
                question: "What is the safest practice when using public Wi-Fi at a cafe or airport?",
                options: [
                    "Avoid using any Wi-Fi that requires a password.",
                    "Assume all connections are secure and browse as normal.",
                    "Use a Virtual Private Network (VPN) for all sensitive activities.",
                    "Only visit websites that start with 'http://'."
                ],
                correctIndex: 2,
                explanation: "Public Wi-Fi is often unencrypted, meaning data can be easily intercepted. A VPN encrypts your connection, protecting your data."
            },
            {
                topic: "Identifying Malware",
                cisControl: "CIS Control 10: Malware Defenses",
                question: "What is the term for software designed to secretly monitor your actions and capture keystrokes?",
                options: [
                    "Adware",
                    "Ransomware",
                    "Spyware",
                    "Firmware"
                ],
                correctIndex: 2,
                explanation: "Spyware is malicious software designed to gather information about a person or organization without their knowledge and send it to another entity."
            },
             {
                topic: "Device Encryption",
                cisControl: "CIS Control 3: Data Protection",
                question: "Why is full-disk encryption (FDE) important for laptops and phones?",
                options: [
                    "It speeds up the device's boot time.",
                    "It prevents unauthorized access to data if the device is lost or stolen.",
                    "It automatically deletes sensitive files after 30 days.",
                    "It prevents phishing emails from reaching the device."
                ]
                ,
                correctIndex: 1,
                explanation: "If a device with FDE is stolen, the data on it is unreadable without the correct decryption key, protecting sensitive information."
            },
             {
                topic: "Data Backup",
                cisControl: "CIS Control 11: Data Recovery",
                question: "What is the most critical principle of effective data backup?",
                options: [
                    "Storing all backups in the cloud.",
                    "Storing backups on a separate, external hard drive.",
                    "The 3-2-1 Rule: 3 copies, 2 media types, 1 offsite.",
                    "Backing up data only once per year."
                ],
                correctIndex: 2,
                explanation: "The 3-2-1 rule is the industry standard: keep 3 copies of your data, on 2 different storage types, with 1 copy located offsite (e.g., in the cloud or a different location)."
            }
        ];
        
        // --- CIS CONTROL DATA (Study Mode) ---
        const CIS_CONTROLS_STUDY = [
        {
            number: 1,
            title: "CIS Control 1: Inventory and Control of Enterprise Assets",
            description: "Identify, track, and manage all hardware assets connected to the network. Unmanaged devices pose security risks and may be exploited by attackers. Maintain an accurate inventory to ensure only authorized systems are granted access to enterprise resources."
        },
        {
            number: 2,
            title: "CIS Control 2: Inventory and Control of Software Assets",
            description: "Maintain a complete inventory of authorized software. Prevent installation or execution of unauthorized applications. Regularly audit software usage and licensing to reduce vulnerabilities and ensure compliance with organizational policies and security standards across all systems."
        },
        {
            number: 3,
            title: "CIS Control 3: Data Protection",
            description: "Protect sensitive data through classification, encryption, and access controls. Ensure secure handling, storage, and disposal of information. Implement safeguards for data in transit and at rest to prevent unauthorized access, leaks, or breaches across enterprise systems."
        },
        {
            number: 4,
            title: "CIS Control 4: Secure Configuration of Enterprise Assets and Software",
            description: "Establish and maintain secure configurations for hardware and software. Disable unnecessary services, ports, and default accounts. Regularly review and update configurations to reduce attack surfaces and ensure systems operate within defined security baselines."
        },
        {
            number: 5,
            title: "CIS Control 5: Account Management",
            description: "Manage user accounts with centralized tools. Create, monitor, and remove accounts based on role and need. Enforce least privilege principles and regularly audit account activity to prevent unauthorized access or privilege escalation within enterprise environments."
        },
        {
            number: 6,
            title: "CIS Control 6: Access Control Management",
            description: "Control access to systems and data using strong authentication. Implement Multi-Factor Authentication (MFA), enforce unique credentials, and restrict access based on roles. Monitor access logs to detect anomalies and prevent unauthorized entry into critical systems."
        },
        {
            number: 7,
            title: "CIS Control 7: Continuous Vulnerability Management",
            description: "Regularly scan systems for known vulnerabilities. Prioritize and remediate issues based on risk. Apply patches promptly and maintain awareness of emerging threats to reduce exposure and strengthen the organizationâ€™s overall security posture."
        },
        {
            number: 8,
            title: "CIS Control 8: Audit Log Management",
            description: "Collect, manage, and analyze audit logs from systems and applications. Ensure logs are protected from tampering and retained for investigations. Use centralized logging to detect suspicious activity and support incident response and forensic analysis."
        },
        {
            number: 9,
            title: "CIS Control 9: Email and Web Browser Protections",
            description: "Secure email clients and web browsers against threats. Disable unnecessary features, apply filters, and enforce safe browsing practices. Prevent access to malicious content and reduce exposure to phishing, malware, and drive-by downloads through configuration controls."
        },
        {
            number: 10,
            title: "CIS Control 10: Malware Defenses",
            description: "Deploy anti-malware solutions across all systems. Scan incoming files, emails, and downloads. Prevent execution of unauthorized software and monitor for signs of infection. Keep malware definitions updated to defend against evolving threats and attack vectors."
        },
        {
            number: 11,
            title: "CIS Control 11: Data Recovery",
            description: "Implement reliable backup solutions for critical data. Follow the 3-2-1 rule: three copies, two media types, one offsite. Test recovery procedures regularly to ensure business continuity and minimize data loss during incidents or disasters."
        },
        {
            number: 12,
            title: "CIS Control 12: Network Infrastructure Management",
            description: "Secure network devices and configurations. Limit administrative access, disable unused ports, and enforce strong credentials. Monitor changes and maintain documentation to ensure network integrity and reduce risks from misconfigurations or unauthorized modifications."
        },
        {
            number: 13,
            title: "CIS Control 13: Network Monitoring and Defense",
            description: "Monitor network traffic for anomalies and threats. Use firewalls, intrusion detection systems, and segmentation to isolate sensitive assets. Analyze logs and alerts to detect attacks early and respond effectively to potential breaches or disruptions."
        },
        {
            number: 14,
            title: "CIS Control 14: Security Awareness and Skills Training",
            description: "Educate personnel on cybersecurity risks and best practices. Conduct regular training on phishing, social engineering, and data handling. Reinforce a security-first culture to reduce human error and improve organizational resilience against evolving threats."
        },
        {
            number: 15,
            title: "CIS Control 15: Service Provider Management",
            description: "Assess and monitor third-party service providers. Ensure contracts include security requirements and data protection clauses. Review vendor practices regularly to confirm compliance and reduce risks from external dependencies or supply chain vulnerabilities."
        },
        {
            number: 16,
            title: "CIS Control 16: Application Software Security",
            description: "Secure applications throughout their lifecycle. Apply secure coding practices, conduct code reviews, and test for vulnerabilities. Ensure updates are applied promptly and that software behaves as intended without exposing sensitive data or system functions."
        },
        {
            number: 17,
            title: "CIS Control 17: Incident Response Management",
            description: "Develop and maintain an incident response plan. Define roles, communication protocols, and escalation procedures. Conduct tabletop exercises and post-incident reviews to improve readiness and minimize impact from security breaches or operational disruptions."
        },
        {
            number: 18,
            title: "CIS Control 18: Penetration Testing",
            description: "Conduct regular penetration tests to identify weaknesses. Simulate real-world attacks to evaluate defenses. Use findings to improve security controls, validate remediation efforts, and ensure systems can withstand targeted exploitation attempts."
        }
        ];


        let dino;
        let obstacles = [];
        let lastTimestamp = 0;
        let currentTopic = null; 

        // --- KEYBOARD NAVIGATION HELPERS ---

        function getFocusableElements(container) {
            return container.querySelectorAll('button:not([disabled])');
        }

        function setFocus(element) {
            if (element && element.focus) {
                element.focus();
            }
        }

        function handleMenuNavigation(key, container) {
            const focusable = getFocusableElements(container);
            const currentFocus = document.activeElement;
            let currentIndex = Array.from(focusable).indexOf(currentFocus);

            if (key === 'ArrowUp') {
                currentIndex = (currentIndex > 0) ? currentIndex - 1 : focusable.length - 1;
                setFocus(focusable[currentIndex]);
            } else if (key === 'ArrowDown') {
                currentIndex = (currentIndex < focusable.length - 1) ? currentIndex + 1 : 0;
                setFocus(focusable[currentIndex]);
            } else if (key === 'Enter' && currentFocus.tagName === 'BUTTON') {
                currentFocus.click();
            }
        }

        // --- UTILITY: SHUFFLE AND SELECT ---
        
        function shuffleAndSelectTopics() {
            const shuffled = [...CYBER_TOPICS]
                .map(value => ({ value, sort: Math.random() }))
                .sort((a, b) => a.sort - b.sort)
                .map(({ value }) => value);
            
            return shuffled.slice(0, MAX_CHECKPOINTS);
        }

        // --- GAME FLOW FUNCTIONS ---

        function showStartMenu() {
             // Reset canvas message
            drawInitialMessage(); 
            
            // Hide all overlays
            messageBox.style.display = 'none';
            gameOverScreen.style.display = 'none';
            studyMode.style.display = 'none';

            // Show start menu
            startMenu.style.display = 'flex';
            
            // Set initial focus for keyboard navigation
            const startButtons = getFocusableElements(startMenuButtons);
            if (startButtons.length > 0) {
                setFocus(startButtons[0]);
            }

            // Reset game state for a clean start
            gameState.isRunning = false;
            gameState.isPausedBySystem = false;
            gameState.mode = 'start';
            
            // Update the static score display
            gameState.highScore = localStorage.getItem('cyberDashHighScore') || 0;
            scoreDisplay.innerHTML = `Score: 0 | High: ${gameState.highScore}`;
            
            // Update instructions for the available modes
            document.getElementById('startInstructions').innerHTML = `
                Quiz Mode: Jump to avoid vulnerabilities and answer questions at checkpoints.
                <br><br>
                Study Mode: Review foundational CIS Controls.
                <br><br>
                Use &uarr; / &darr; to navigate menus and ENTER to select.
            `;
        }
        
        function startQuizMode() {
            gameState.mode = 'quiz';
            startMenu.style.display = 'none';
            initGame();
        }

        function startStudyMode() {
            gameState.mode = 'study';
            gameState.currentCisIndex = 0; // Start at the first control
            startMenu.style.display = 'none';
            studyMode.style.display = 'flex';
            displayCisControl(gameState.currentCisIndex);
            
            // Set initial focus on the exit button
            setFocus(exitStudyButton);
        }
        
        function exitStudyMode() {
            studyMode.style.display = 'none';
            showStartMenu();
        }
        
        function displayCisControl(index) {
    const control = CIS_CONTROLS_STUDY[index];
    if (!control) {
        exitStudyMode();
        return;
    }

    cisIndex.textContent = `CIS CONTROL ${index + 1} OF ${CIS_CONTROLS_STUDY.length}`;
    cisTitle.textContent = control.title;
    cisDescription.textContent = control.description;

    // Remove any previously added image
    const existingImage = document.getElementById('cisImage');
    if (existingImage) {
        existingImage.remove();
    }

    // Conditionally add image for CIS Control 1
    /*if (control.number === 1) {
        const img = document.createElement('img');
        img.src = "https://media.wired.com/photos/5ceeed5b0bdd96c34c6174a3/master/w_1600%2Cc_limit/01_Ferrari_SF90_03.jpg";
        img.alt = "Illustration for CIS Control 1";
        img.id = "cisImage";
        img.style.maxWidth = "150px";
        img.style.marginTop = "10px";
        img.style.border = "2px solid #333";
        cisDescription.parentNode.appendChild(img);
    } */
}


        // --- QUIZ GAME LOGIC ---

        function initGame() {
            // Reset game state for the runner
            gameState.score = 0;
            gameState.isRunning = true;
            gameState.isPausedBySystem = false;
            gameState.speed = 5;
            gameState.obstaclesPassedCount = 0; 
            gameState.checkpointsCleared = 0; 
            obstacles = [];
            
            gameState.currentQuestionSet = shuffleAndSelectTopics(); 
            
            setGameOverScreen(false); // Reset to loss message
            messageBox.style.display = 'none';
            gameOverScreen.style.display = 'none';

            // Initialize entities
            dino = new Dinosaur();

            // Start the main loop
            if (gameState.animationFrameId) {
                cancelAnimationFrame(gameState.animationFrameId);
            }
            lastTimestamp = performance.now();
            gameLoop(lastTimestamp);
        }
        
        function drawGround() {
            ctx.strokeStyle = GROUND_COLOR;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(0, GROUND_Y);
            ctx.lineTo(canvas.width, GROUND_Y);
            ctx.stroke();
        }

        function generateObstacle() {
            const minHeight = 20;
            const maxHeight = 40;
            const minWidth = 10;
            const maxWidth = 30;

            const height = Math.random() * (maxHeight - minHeight) + minHeight;
            const width = Math.random() * (maxWidth - minWidth) + minWidth;

            obstacles.push(new Obstacle(width, height));
        }

        function checkCollision(dino, obstacle) {
            return (
                dino.x < obstacle.x + obstacle.width &&
                dino.x + dino.width > obstacle.x &&
                dino.y < obstacle.y + obstacle.height &&
                dino.y + dino.height > obstacle.y
            );
        }
        
        function updateSpeedAndDifficulty() {
            if (gameState.score > 0 && Math.floor(gameState.score) % 100 === 0) {
                if (Math.floor(gameState.score) !== gameState.lastScoreBeforeSpeedIncrease) {
                    gameState.speed = Math.min(gameState.speed + 0.5, 10); 
                    gameState.lastScoreBeforeSpeedIncrease = Math.floor(gameState.score); 
                }
            }
        }

        function gameLoop(timestamp) {
            const deltaTime = timestamp - lastTimestamp;
            lastTimestamp = timestamp;

            scoreDisplay.innerHTML = `Score: ${Math.floor(gameState.score)} | High: ${gameState.highScore}`;
            
            if (gameState.isRunning && !gameState.isPausedBySystem) {
                // 1. Clear Canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // 2. Draw Ground
                drawGround();

                // 3. Update Dino
                dino.update();
                dino.draw();

                // 4. Update Score
                gameState.score += 0.05; 
                updateSpeedAndDifficulty();
                
                // 5. Obstacle Logic
                gameState.timeSinceLastObstacle += deltaTime;
                if (gameState.timeSinceLastObstacle > gameState.obstacleGenerationInterval) {
                    generateObstacle();
                    gameState.timeSinceLastObstacle = 0;
                    gameState.obstacleGenerationInterval = Math.max(800, gameState.obstacleGenerationInterval * 0.98);
                }

                obstacles.forEach((obstacle) => {
                    obstacle.update();
                    obstacle.draw();

                    if (checkCollision(dino, obstacle)) {
                        gameOver();
                        return; 
                    }

                    if (obstacle.x + obstacle.width < dino.x && !obstacle.passed) {
                        obstacle.passed = true;
                        gameState.obstaclesPassedCount++;
                    }
                });

                if (gameState.obstaclesPassedCount >= BLOCKS_PER_CHECKPOINT) {
                    gameState.obstaclesPassedCount = 0;
                    pauseGameForSecurityCheck();
                }

                obstacles = obstacles.filter(obstacle => obstacle.x + obstacle.width > 0);
            }
            
            gameState.animationFrameId = requestAnimationFrame(gameLoop);
        }

        function setGameOverScreen(isWin = false) {
            finalScoreSpan.textContent = Math.floor(gameState.score);
            if (isWin) {
                gameOverScreen.querySelector('h2').textContent = 'MISSION COMPLETE!';
                gameOverScreen.querySelector('h2').style.color = '#006400'; 
                gameOverScreen.querySelector('p').innerHTML = `You successfully cleared all security checkpoints with a final score of <span id="finalScore">${Math.floor(gameState.score)}</span>!`;
                restartButton.textContent = 'Start New Scan';
                backToMenuButton.style.backgroundColor = '#007bff';
            } else {
                gameOverScreen.querySelector('h2').textContent = 'GAME OVER!';
                gameOverScreen.querySelector('h2').style.color = '#ff0000'; 
                gameOverScreen.querySelector('p').innerHTML = `You tripped over a vulnerability at <span id="finalScore">${Math.floor(gameState.score)}</span> points.`;
                restartButton.textContent = 'Retry Scan';
                backToMenuButton.style.backgroundColor = '#007bff';
            }
        }

        function gameOver() {
            gameState.isRunning = false;
            setGameOverScreen(false);
            gameOverScreen.style.display = 'flex';
            
            // Set initial focus on restart button
            const focusable = getFocusableElements(gameOverButtons);
            if (focusable.length > 0) {
                setFocus(focusable[0]);
            }

            if (Math.floor(gameState.score) > gameState.highScore) {
                gameState.highScore = Math.floor(gameState.score);
                localStorage.setItem('cyberDashHighScore', gameState.highScore);
                scoreDisplay.innerHTML = `Score: ${Math.floor(gameState.score)} | High: ${gameState.highScore} (NEW!)`;
            }
            
            cancelAnimationFrame(gameState.animationFrameId);
        }

        function gameWin() {
            gameState.isRunning = false;
            setGameOverScreen(true); 
            gameOverScreen.style.display = 'flex';
            
            // Set initial focus on restart button
            const focusable = getFocusableElements(gameOverButtons);
            if (focusable.length > 0) {
                setFocus(focusable[0]);
            }

            if (Math.floor(gameState.score) > gameState.highScore) {
                gameState.highScore = Math.floor(gameState.score);
                localStorage.setItem('cyberDashHighScore', gameState.highScore);
                scoreDisplay.innerHTML = `Score: ${Math.floor(gameState.score)} | High: ${gameState.highScore} (NEW!)`;
            }

            cancelAnimationFrame(gameState.animationFrameId);
        }
        
        function pauseGameForSecurityCheck() {
            
            if (gameState.checkpointsCleared >= MAX_CHECKPOINTS) {
                gameWin();
                return;
            }

            gameState.isRunning = false;
            gameState.isPausedBySystem = true;
            gameState.checkpointsCleared++; 

            currentTopic = gameState.currentQuestionSet[gameState.checkpointsCleared - 1]; 

            modalTitle.textContent = 'SECURITY CHECKPOINT REACHED!';
            questionCounter.textContent = `Question ${gameState.checkpointsCleared} of ${MAX_CHECKPOINTS}`;
            topicText.textContent = `Topic: ${currentTopic.topic}`;
            cisControlText.textContent = `(${currentTopic.cisControl})`;
            questionText.textContent = `Q: ${currentTopic.question}`;
            
            feedbackText.style.display = 'none';
            continueButton.style.display = 'none';
            optionContainer.innerHTML = ''; 

            currentTopic.options.forEach((optionText, index) => {
                const button = document.createElement('button');
                button.textContent = optionText;
                button.classList.add('option-button');
                button.dataset.index = index;
                button.tabIndex = 0; // Make it focusable

                button.addEventListener('click', handleAnswer);
                optionContainer.appendChild(button);
            });
            
            messageBox.style.display = 'flex';
            
            // Set initial focus on the first option
            const options = getFocusableElements(optionContainer);
            if (options.length > 0) {
                setFocus(options[0]);
            }
        }

        function handleAnswer(event) {
            if (!currentTopic) return;

            const selectedButton = event.currentTarget;
            const selectedIndex = parseInt(selectedButton.dataset.index);
            const isCorrect = selectedIndex === currentTopic.correctIndex;
            const allButtons = optionContainer.querySelectorAll('.option-button');

            allButtons.forEach(btn => {
                btn.disabled = true;
                btn.removeEventListener('click', handleAnswer);
            });

            if (isCorrect) {
                selectedButton.classList.add('correct-answer');
                feedbackText.textContent = `CORRECT! (+15 pts)\n\nExplanation: ${currentTopic.explanation}`;
                gameState.score += 15;
            } else {
                selectedButton.classList.add('incorrect-answer');
                allButtons[currentTopic.correctIndex].classList.add('correct-answer');
                feedbackText.textContent = `INCORRECT. The correct answer is highlighted.\n\nExplanation: ${currentTopic.explanation}`;
            }

            feedbackText.style.display = 'block';
            continueButton.style.display = 'inline-block';
            
            if (gameState.checkpointsCleared >= MAX_CHECKPOINTS) {
                continueButton.textContent = 'Mission Accomplished!';
            } else {
                 continueButton.textContent = 'Continue Run';
            }

            scoreDisplay.innerHTML = `Score: ${Math.floor(gameState.score)} | High: ${gameState.highScore}`;
            
            // Shift focus to the continue button
            setFocus(continueButton);
        }
        
        function resumeGame() {
            messageBox.style.display = 'none';
            
            if (gameState.checkpointsCleared >= MAX_CHECKPOINTS) {
                gameWin();
                return;
            }

            obstacles = []; 
            gameState.timeSinceLastObstacle = 0; 
            
            gameState.isRunning = true;
            gameState.isPausedBySystem = false;
            lastTimestamp = performance.now(); 
        }

        // --- EVENT LISTENERS ---

        document.addEventListener('keydown', (e) => {
            const key = e.code;
            
            // Game Running Controls (Jump)
            if (gameState.mode === 'quiz' && gameState.isRunning) {
                if (key === 'Space' || key === 'ArrowUp') {
                    e.preventDefault(); 
                    dino.jump();
                }
                return; 
            }
            
            // --- MENU NAVIGATION LOGIC ---
            if (['ArrowUp', 'ArrowDown', 'Enter'].includes(key)) {
                e.preventDefault(); 

                if (gameState.mode === 'start' && startMenu.style.display === 'flex') {
                    handleMenuNavigation(key, startMenuButtons);
                } 
                else if (gameOverScreen.style.display === 'flex') {
                    handleMenuNavigation(key, gameOverButtons);
                }
                else if (gameState.isPausedBySystem && messageBox.style.display === 'flex') {
                    const optionsDisabled = optionContainer.querySelector('.option-button[disabled]');
                    
                    if (!optionsDisabled) {
                        // Options are active (before answering)
                        handleMenuNavigation(key, optionContainer);
                    } else {
                        // Options are answered, focus is on Continue Button
                        if (key === 'Enter' && document.activeElement === continueButton) {
                            continueButton.click();
                        }
                    }
                }
                else if (gameState.mode === 'study' && studyMode.style.display === 'flex' && key === 'Enter') {
                    // Allows ENTER to trigger Exit Study button if focused
                    if (document.activeElement === exitStudyButton) {
                        exitStudyButton.click();
                    }
                }
            } 
            // --- STUDY CONTENT NAVIGATION (ArrowLeft/ArrowRight) ---
            else if (['ArrowLeft', 'ArrowRight'].includes(key)) {
                if (gameState.mode === 'study' && studyMode.style.display === 'flex') {
                    const totalControls = CIS_CONTROLS_STUDY.length;
                    if (key === 'ArrowRight') {
                        gameState.currentCisIndex = (gameState.currentCisIndex + 1) % totalControls;
                    } else if (key === 'ArrowLeft') {
                        gameState.currentCisIndex = (gameState.currentCisIndex - 1 + totalControls) % totalControls;
                    }
                    displayCisControl(gameState.currentCisIndex);
                    setFocus(exitStudyButton); // Keep focus on exit button after content change
                }
            }
        });

        canvas.addEventListener('click', (e) => {
             // Only allow jump/start if not in a menu and not paused by system
             if (gameState.mode === 'quiz' && gameState.isRunning && !gameState.isPausedBySystem) {
                dino.jump();
            } else if (gameState.mode === 'start' && startMenu.style.display === 'flex') {
                // If canvas is clicked while in the start menu, default to Quiz Mode
                startQuizMode(); 
            }
        });

        // Button listeners (kept for mouse/touch functionality)
        quizModeButton.addEventListener('click', startQuizMode);
        studyModeButton.addEventListener('click', startStudyMode);
        
        exitStudyButton.addEventListener('click', exitStudyMode);
        
        continueButton.addEventListener('click', resumeGame);
        restartButton.addEventListener('click', initGame); // Retry Scan button starts the game again
        backToMenuButton.addEventListener('click', showStartMenu); // Back to menu button goes to start menu

        // --- INITIAL DISPLAY ---
        
        function drawInitialMessage() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawGround();
            ctx.fillStyle = DINO_COLOR;
            ctx.fillRect(50, GROUND_Y - DINO_HEIGHT, DINO_WIDTH, DINO_HEIGHT); 
            
            ctx.fillStyle = GROUND_COLOR;
            ctx.font = '12px "Press Start 2P"'; 
            ctx.textAlign = 'center';
            ctx.fillText("CYBER DASH RUNNER", canvas.width / 2, canvas.height / 2 - 10);
            ctx.font = '8px "Press Start 2P"';
            ctx.fillText("Select a mode to begin", canvas.width / 2, canvas.height / 2 + 10);
        }

        window.onload = () => {
            const container = document.querySelector('.game-container');
            canvas.width = container.clientWidth - 40; 
            
            gameState.highScore = localStorage.getItem('cyberDashHighScore') || 0;
            
            // Start the game loop only to draw the initial screen and handle resizes
            showStartMenu();
        };

        window.addEventListener('resize', () => {
             const container = document.querySelector('.game-container');
             canvas.width = container.clientWidth - 40;
             if (gameState.mode === 'start') {
                drawInitialMessage();
             }
        });

    </script>
</body>
</html>
